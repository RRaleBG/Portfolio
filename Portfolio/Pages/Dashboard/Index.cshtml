@page
@model Portfolio.Pages.Dashboard.IndexModel
@{
    ViewData["Title"] = "Dashboard";
}
<section class="container-xxl">


    <h2 class="mb-3">Dashboard</h2>

    <div class="row g-3">
        <div class="col-md-3">
            <div class="card hover-lift">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fs-4">Projects</div>
                            <div class="display-6">@Model.CountProjects</div>                      
                            <div class="mt-2">
                                <a class="btn btn-sm btn-primary" asp-page="/Admin/Projects/Index">Manage</a>
                                <a class="btn btn-sm btn-success" asp-page="/Admin/Projects/Create">New</a>
                            </div>
                        </div>                   
                    </div>
                </div>
            </div>
        </div>


        <div class="col-md-3">
            <div class="card hover-lift">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fs-4">Blog Posts</div>
                            <div class="display-6">@Model.CountPosts</div>
                            <div class="mt-2">
                                <a class="btn btn-sm btn-primary" asp-page="/Admin/Blog/Index">Manage</a>
                                <a class="btn btn-sm btn-success" asp-page="/Admin/Blog/Create">New</a>
                            </div>
                        </div>          
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card hover-lift">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <div class="fs-4">Interactions</div>
                            <div class="display-6">@Model.CountInteractions</div>
                            <div class="mt-2">
                                <a class="btn btn-sm btn-primary" asp-page="/Admin/Interactions/Index">View</a>
                            </div>
                        </div>          
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3">
            <div class="card hover-lift">
                <div class="card-body">
                    <div class="fs-4">Total Visits</div>
                    <div class="display-6">@Model.TotalVisits</div>
                    <div class="mt-2">Current Visitors (last 10 min): <span class="fw-bold">@Model.CurrentVisitors</span></div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card hover-lift">
                <div class="card-body">
                    <div class="fs-4">Mail Sent</div>
                    <div class="display-6">@Model.TotalMailSent</div>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header">Visits Per Page</div>
        <div class="card-body">
            <ul class="list-unstyled mb-0">
                @foreach (var kv in Model.PageVisitCounts)
                {
                    <li><strong>@kv.Key:</strong> @kv.Value</li>
                }
            </ul>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header">Live Notifications</div>
        <div class="card-body">
            <ul id="notif-list" class="list-unstyled mb-0"></ul>
        </div>
    </div>

    <div class="card mt-3">
        <div class="card-header">Recent Visitors</div>
        <div class="card-body">
            <div class="table table-sm overflow-scroll">
                <div class="row card-body">
                    <div class="col">IP</div>
                    <div class="col">Page</div>
                    <div class="col">Time</div>
          
                    @foreach (var v in Model.RecentVisits)
                    {
                        <div class="row card-body ">
                            <div class="col">@v.IpAddress</div>
                            <div class="col">@v.Page</div>
                            <div class="col">@v.Timestamp.ToLocalTime().ToString("g")</div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
<script src="~/js/signalR.js" asp-append-version="true"></script>
<script>
(function(){
    const list = document.getElementById('notif-list');
    function add(msg){ const li=document.createElement('li'); li.textContent = msg; list.prepend(li); }
    const conn = new signalR.HubConnectionBuilder().withUrl('/hubs/notifications').build();
    conn.on('notify', msg => add(msg));
    conn.start().catch(console.error);
})();
</script>
}
